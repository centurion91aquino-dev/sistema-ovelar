<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Ovelar</title>
    <style>
        body { font-family: sans-serif; background: #1e3c72; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; }
        .card { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; box-sizing: border-box; }
        .hidden { display: none; }
        input { padding: 12px; width: 100%; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button { padding: 12px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .menu-item { background: #f1f1f1; padding: 20px; border-radius: 10px; cursor: pointer; border: 1px solid #ddd; }
        .full-screen { max-width: 900px; text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #eee; text-align: left; }
        th { background: #34495e; color: white; }
        .img-tabla { width: 50px; height: 50px; object-fit: cover; }
    </style>
</head>
<body>

    <div id="login-screen" class="card">
        <h2>SISTEMA OVELAR</h2>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <button onclick="ejecutarLogin()">INGRESAR</button>
        <p id="msg-error" style="color:red;"></p>
    </div>

    <div id="menu-screen" class="card hidden" style="max-width: 500px;">
        <h2>Men√∫ Principal</h2>
        <div class="menu-grid">
            <div class="menu-item" onclick="mostrarSeccion('venta-screen')">üõí VENTAS</div>
            <div class="menu-item" onclick="abrirProductos()">üì¶ PRODUCTOS</div>
        </div>
        <br><button onclick="location.reload()" style="background:#7f8c8d">Cerrar Sesi√≥n</button>
    </div>

    <div id="prod-screen" class="card full-screen hidden">
        <button onclick="mostrarSeccion('menu-screen')" style="width:auto;">‚Üê Volver</button>
        <h3>Gesti√≥n de Inventario</h3>
        <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
            <input type="text" id="p-cod" placeholder="C√≥digo">
            <input type="text" id="p-nom" placeholder="Nombre del Producto">
            <input type="number" id="p-pre" placeholder="Precio Gs.">
            <input type="number" id="p-stock" placeholder="Stock">
            <input type="text" id="p-img" placeholder="Link de Foto (URL)">
            <button onclick="guardarProducto()" style="background:#27ae60">GUARDAR</button>
        </div>
        <table>
            <thead><tr><th>Foto</th><th>C√≥d</th><th>Nombre</th><th>Precio</th><th>Stock</th></tr></thead>
            <tbody id="lista-prod-body"></tbody>
        </table>
    </div>

    <div id="venta-screen" class="card full-screen hidden">
        <button onclick="mostrarSeccion('menu-screen')" style="width:auto;">‚Üê Volver</button>
        <h3>M√≥dulo de Ventas</h3>
        <p>Busca productos para vender...</p>
    </div>

    <script>
        function mostrarSeccion(id) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('prod-screen').classList.add('hidden');
            document.getElementById('venta-screen').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }

        async function ejecutarLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            const msg = document.getElementById('msg-error');
            
            msg.innerText = "Verificando...";

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({nombre_usuario: u, contrasena: p})
                });
                const data = await response.json();
                
                if(data.success) {
                    mostrarSeccion('menu-screen');
                } else {
                    msg.innerText = "Usuario o clave incorrectos";
                }
            } catch (err) {
                msg.innerText = "Error de conexi√≥n con el servidor";
                console.error(err);
            }
        }

        async function abrirProductos() {
            mostrarSeccion('prod-screen');
            listarProductos();
        }

        async function listarProductos() {
            const res = await fetch('/productos');
            const data = await res.json();
            let html = '';
            data.forEach(p => {
                html += `<tr>
                    <td><img src="${p.imagen_url || ''}" class="img-tabla" onerror="this.src='https://via.placeholder.com/50'"></td>
                    <td>${p.codigo}</td><td>${p.nombre}</td><td>${Number(p.precio).toLocaleString()}</td><td>${p.stock}</td>
                </tr>`;
            });
            document.getElementById('lista-prod-body').innerHTML = html;
        }

        async function guardarProducto() {
            const prod = {
                codigo: document.getElementById('p-cod').value,
                nombre: document.getElementById('p-nom').value,
                precio: document.getElementById('p-pre').value,
                stock: document.getElementById('p-stock').value,
                imagen_url: document.getElementById('p-img').value
            };
            const res = await fetch('/guardar-producto', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(prod)
            });
            if(res.ok) {
                alert("Guardado");
                listarProductos();
            }
        }
    </script>
</body>
</html>
